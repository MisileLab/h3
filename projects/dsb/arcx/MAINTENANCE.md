# ArcX Maintenance Guide

Guide for keeping dependencies up-to-date and maintaining the project.

## Quick Commands

```bash
# Update all dependencies
just update

# Update + rebuild everything
just upgrade

# Check for outdated packages
just status
```

## Updating Dependencies

### Update Everything (Recommended)

```bash
# Update backend dependencies
just upgrade
```

This will:
1. Update backend dependencies (`uv lock --upgrade`)
2. Sync with updated lock file

### Update Backend

```bash
just update-backend
```

This runs:
```bash
cd backend
uv lock --upgrade    # Update uv.lock
uv sync              # Install new versions
```

## Manual Updates

### Backend (Python with uv)

```bash
cd backend

# Update all dependencies
uv lock --upgrade
uv sync

# Update specific package
uv add package-name@latest

# Check what would be updated
uv lock --upgrade --dry-run
```

## Checking Status

### System Status

```bash
just status
```

Shows:
- Device backend (CUDA/ROCm/DirectML/CPU)
- Trained models
- Data files
- Build status

### Package Status

**Backend:**
```bash
cd backend
uv pip list              # List installed packages
uv pip show torch        # Show specific package info
```

## Version Pinning

### Pin Specific Versions

**Backend (pyproject.toml):**
```toml
dependencies = [
    "torch==2.1.0",           # Exact version
    "polars>=0.19.0,<0.20.0", # Range
    "numpy~=1.24.0",          # Compatible version
]
```

### Lock Files

**Backend: uv.lock**
- Auto-generated by `uv lock`
- Contains exact versions of all dependencies
- Commit to git for reproducibility

## Update Strategies

### Conservative (Recommended for Production)

Update only patch versions:
```bash
cd backend
uv add package-name@~1.2.3  # Only 1.2.x
```

### Moderate (Default)

Update minor versions:
```bash
cd backend
uv lock --upgrade
uv sync
```

### Aggressive (Latest Everything)

Update to latest versions:
```bash
cd backend
uv add package-name@latest
```

## Security Updates

### Check for Vulnerabilities

**Backend:**
```bash
cd backend
uv pip audit  # Check for known vulnerabilities (if available)
```

### Update Security Patches

```bash
# Update only security patches
just update
```

## Breaking Changes

### Before Major Updates

1. **Check changelog:**
   ```bash
   uv pip show torch | grep "Home-page"
   ```

2. **Test in isolation:**
   ```bash
   # Create test branch
   git checkout -b test-updates
   just update
   just test
   ```

3. **Review changes:**
   ```bash
   git diff backend/uv.lock
   ```

### Handling Breaking Changes

**Backend:**
```python
# Check Python version compatibility
import sys
assert sys.version_info >= (3, 10)

# Check torch version
import torch
print(torch.__version__)
```

## Rollback

### Rollback to Previous Version

**Backend:**
```bash
cd backend
git checkout backend/uv.lock  # Restore old lock file
uv sync                       # Install old versions
```

## CI/CD Updates

### GitHub Actions

```yaml
name: Update Dependencies
on:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v1

      - name: Update dependencies
        run: just update

      - name: Run tests
        run: just test

      - name: Create PR
        uses: peter-evans/create-pull-request@v5
        with:
          title: "chore: update dependencies"
          body: "Automated dependency update"
```

## Best Practices

### 1. Regular Updates

- **Weekly**: Check for updates
- **Monthly**: Apply updates
- **Quarterly**: Major version updates

### 2. Test After Updates

```bash
just update
just test              # Run all tests
just test-model        # Test ML components
just benchmark-inference  # Check performance
```

### 3. Commit Lock Files

```bash
git add backend/uv.lock
git commit -m "chore: update dependencies"
```

### 4. Document Breaking Changes

Create `CHANGELOG.md`:
```markdown
## [0.2.0] - 2024-01-15

### Changed
- Updated PyTorch from 2.0.0 to 2.1.0
- Updated TypeScript from 4.9 to 5.0

### Breaking Changes
- PyTorch 2.1 requires CUDA 11.8+
```

## Troubleshooting

### uv Issues

**Problem:** `Package has conflicting dependencies`
```bash
# Clear cache
rm -rf ~/.cache/uv

# Regenerate lock file
cd backend
rm uv.lock
uv lock
```

**Problem:** `Failed to build package`
```bash
# Install build dependencies
uv pip install build setuptools wheel
```

## Monitoring

### Dependabot (GitHub)

Create `.github/dependabot.yml`:
```yaml
version: 2
updates:
  # Python dependencies
  - package-ecosystem: "pip"
    directory: "/backend"
    schedule:
      interval: "weekly"
```

### Renovate Bot

Create `renovate.json`:
```json
{
  "extends": ["config:base"],
  "packageRules": [
    {
      "matchUpdateTypes": ["minor", "patch"],
      "automerge": true
    }
  ]
}
```

## Summary

| Task | Command |
|------|---------|
| Update everything | `just update` |
| Update + rebuild | `just upgrade` |
| Backend only | `just update-backend` |
| Check status | `just status` |
| Test after update | `just test` |
| Rollback | `git checkout backend/uv.lock` + sync |

---

**Remember:** Always test after updating! ðŸ§ª
