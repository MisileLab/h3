---
import MainLayout from '../layouts/main.astro';
---

<MainLayout title="계약서 분석 리포트">
  <div class="container mx-auto px-6 py-12">
    <div class="bg-white p-8 rounded-lg shadow-md">
      <div class="border-b pb-4 mb-6">
        <h1 class="text-3xl font-bold text-gray-800">분석 리포트</h1>
      </div>

      <div id="analysis-container" class="space-y-6"></div>

      <div class="mt-12 text-center p-8 bg-gray-100 rounded-lg">
        <h2 class="text-2xl font-bold text-gray-800">전문가의 도움이 필요하신가요?</h2>
        <p class="text-gray-600 mt-2 mb-6">AI 분석만으로 해결하기 어려운 복잡한 문제가 있다면, 전문 노무사/변호사와 상담하세요.</p>
        <a href="#" class="bg-blue-500 text-white px-8 py-4 rounded-md text-lg font-semibold hover:bg-blue-600">전문가 연결하기</a>
      </div>
    </div>
  </div>
</MainLayout>

<script>
  const analysisContainer = document.getElementById('analysis-container');
  const reportDataString = sessionStorage.getItem('analysisReport');

  function getRiskClass(risk) {
    switch (risk) {
      case '위험': return 'bg-red-100 text-red-800';
      case '주의': return 'bg-yellow-100 text-yellow-800';
      case '안전': return 'bg-green-100 text-green-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  }

  if (reportDataString) {
    try {
      const reportData = JSON.parse(reportDataString);

      if (reportData.analyses && Array.isArray(reportData.analyses)) {
        if (reportData.analyses.length === 0) {
            analysisContainer.innerHTML = '<p>분석된 조항이 없습니다.</p>';
        } else {
            reportData.analyses.forEach(clause => {
              const clauseElement = document.createElement('div');
              clauseElement.className = 'border rounded-lg p-6 transition-shadow hover:shadow-lg';

              clauseElement.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                  <h3 class="text-xl font-semibold text-gray-800">${clause.original_line || 'N/A'}</h3>
                  <span class="px-3 py-1 text-sm font-bold rounded-full ${getRiskClass(clause.risk)}">
                    ${clause.risk}
                  </span>
                </div>
                <div class="mb-4">
                    <p class="font-semibold text-gray-700">원본 계약서 내용 ( ${clause.original_line} )</p>
                    <p class="text-gray-600 mt-2 bg-gray-50 p-4 rounded">${clause.original_content}</p>
                </div>
                <div class="mt-4 p-4 rounded-lg bg-blue-50 border border-blue-200">
                  <p class="font-semibold text-blue-800">AI 분석 및 근거</p>
                  <p class="text-gray-700 mt-2"><strong>- 근거 법령:</strong> ${clause.law_line} - ${clause.law_content}</p>
                  <p class="text-gray-700 mt-2"><strong>- AI 의견:</strong> ${clause.reasoning}</p>
                </div>
              `;
              analysisContainer.appendChild(clauseElement);
            });
        }
      } else if (reportData.error) {
        analysisContainer.innerHTML = `<p class="text-red-500">분석 오류: ${reportData.error}</p>`;
      } else {
        analysisContainer.innerHTML = "<p>분석 데이터를 찾을 수 없습니다.</p>";
      }
    } catch (e) {
        analysisContainer.innerHTML = `<p class="text-red-500">리포트 데이터를 파싱하는 데 실패했습니다.</p>`;
        console.error("Failed to parse report data:", e);
    }
  } else {
    analysisContainer.innerHTML = "<p>세션 스토리지에서 분석 데이터를 찾을 수 없습니다.</p>";
  }
</script>