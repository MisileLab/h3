---
import Base from "../../../components/base.astro"
import Modal from "../../../components/modal.astro"
import { type Post, f } from "./example"

import { nullValue } from "@misile/satellite/errors"
import { nullVerify } from "@misile/satellite"

let post: Post | null = null;

try {
  const slug = nullVerify(Astro.params.slug)
  post = nullVerify(f[slug])
}
catch (e) {
  if (e instanceof nullValue) {
    return new Response("Not found", { status: 404 })
  } else {
    throw e
  }
}
---

<Base>
  <Fragment slot="head">
    <title>{post.title}</title>
    <script>
      import { queryAll, queryId, nullVerify } from "@misile/satellite"
      import { atom } from "nanostores"

      const m = queryId("modal") as HTMLDialogElement;
      const n = queryId("modal-email")
      const data: any[] = JSON.parse(nullVerify(n.dataset.data))
      const opened = atom(false)
      const email = atom("")

      for (let i of queryAll("#name")) {
        i.addEventListener('click', ()=>{
          email.set(nullVerify(data.find((x: any)=>x['name']===i.dataset.name)['email']))
          opened.set(true)
        })
      }
      for (let i of queryAll("#signature")) {
        i.addEventListener('click', ()=>{
          email.set(nullVerify(data.find((x: any)=>x['name']===i.dataset.name)['email']))
          opened.set(true)
        })
      }

      const cl = m.classList
      opened.subscribe((x)=>{
        if (x) {
          m.showModal()
          cl.add('w-1/2')
          cl.add('h-1/2')
        } else {
          m.close()
          cl.remove('w-1/2')
          cl.remove('h-1/2')
        }
      })
      email.subscribe((x)=>{
        let d: Object | undefined = undefined;
        n.innerText = x
        if (d === undefined) {return;}
        console.log(d)
      })

      queryId("close").addEventListener('click', ()=>{
        opened.set(false)
      })
    </script>
  </Fragment>
  <div class="w-full h-full flex flex-col items-center justify-center">
    <div class="w-full h-full flex flex-row font-bold text-7xl justify-center py-[6%]">
      <Modal id="modal" classv="w-1/2 h-1/2 fixed bg-white">
        <div class="w-full flex flex-col justify-between bg-white h-full">
          <div class="flex flex-col justify-start w-full">
            <div id="modal-email" data-data={JSON.stringify(post.signers)} />
          </div>
          <div class="flex flex-row justify-center">
            <button id="close" class="w-fit h-fit border-2 border-solid px-2 outline-none">Close</button>
          </div>
        </div>
      </Modal>
      <div class="flex flex-col">
        {post.signers.map((signer) => {
          return <span class="font-bold inline-block cursor-pointer" id="name" data-name={signer.name}>{signer.name}</span>
        })}
      </div>
      <div class="flex flex-col">
        {post.signers.map((signer) => {
          return <img src={signer.signature} data-name={signer.name} id="signature" alt="" class={`h-[1em] cursor-pointer ${signer.signature!==undefined?"":"w-0"}`} />
        })}
      </div>
    </div>
	</div>
</Base>
